_id: qTMsqCxw9sGT0uL7
_key: '!macros!qTMsqCxw9sGT0uL7'
_stats:
  coreVersion: '13.351'
author: N8Qq94zyfscJUwL4
command: |-
  // Spend Power Points Script Call for PF1-Psionics
  // Designed to be attached to an item's "use" script call category
  // This will spend power points when an item is used
  
  const cost = 1; // Power Point cost to spend
  
  // Validate we have an actor
  if (!actor) {
    ui.notifications.error("No actor found for this item.");
    shared.reject = true;
    return;
  }
  
  // Get power points from actor flags
  const powerPoints = actor.flags?.["pf1-psionics"]?.powerPoints;
  if (!powerPoints) {
    ui.notifications.error("This actor does not have power points. Ensure the PF1-Psionics module is active and the actor has manifesting capability.");
    shared.reject = true;
    return;
  }
  
  // Check if actor has enough power points
  const currentPP = (powerPoints.current || 0);
  const tempPP = (powerPoints.temporary || 0);
  const totalAvailable = currentPP + tempPP;
  
  if (cost > totalAvailable) {
    ui.notifications.error(`Cannot use ${item.name}. Requires ${cost} power points but only ${totalAvailable} available.`);
    shared.reject = true;
    return;
  }
  
  // Use the item's addCharges method to spend power points
  // This ensures consistency with the system's power point management
  // Note: addCharges with negative value spends points
  try {
    await item.addCharges(-cost);
    
    // Success notification
    const remaining = totalAvailable - cost;
    ui.notifications.info(`${actor.name} spent ${cost} power point${cost !== 1 ? 's' : ''} to use ${item.name}. (${remaining} / ${powerPoints.maximum} remaining)`);
  } catch (error) {
    console.error("Failed to spend power points:", error);
    ui.notifications.error(`Failed to spend power points for ${item.name}.`);
    shared.reject = true;
    return;
  }
img: icons/magic/symbols/runes-star-magenta.webp
name: Spend Power Points
scope: global
type: script
